name: Build

on:
  push:
    branches:
      - master
      - 'ver/**'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Branch
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'

      - name: Install Dependencies
        run: yarn install

      - name: Build Docs
        run: 'yarn run docs:build'

      - name: Push to Publish Branch
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          BRANCH=$(echo ${GITHUB_REF} | sed -e 's/refs\/heads\///')
          TARGET_BRANCH="build/${BRANCH}"
          COMMIT_MSG=$(git log -1 --pretty=%B)
          ORIGIN_URL=$(git config --get remote.origin.url)
          
          git subtree push --prefix=docs/.vitepress/dist origin ${TARGET_BRANCH}
          
          echo "Branch: ${BRANCH}"
          echo "Pushing to ${TARGET_BRANCH}"
          echo "Origin URL: ${ORIGIN_URL}"
          echo "Commit Message: ${COMMIT_MSG}"